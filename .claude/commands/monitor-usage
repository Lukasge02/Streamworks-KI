#!/bin/bash

# Monitor Claude Code Usage - Track token usage and costs
echo "ğŸ“Š Monitoring Claude Code usage and costs..."

echo ""
echo "ğŸ’° Step 1: Claude Code Usage Analysis"
if command -v ccusage &> /dev/null; then
    echo "   Running detailed usage analysis..."
    npx ccusage --detailed --format=table
else
    echo "   âš ï¸ ccusage not found. Installing..."
    npm install -g @claude/ccusage 2>/dev/null || echo "   âŒ Failed to install ccusage"
fi

echo ""
echo "ğŸ” Step 2: Token Usage Patterns"
if [ -f "../.claude/tool-use.log" ]; then
    echo "   Analyzing tool usage patterns..."
    echo "   Total tool operations: $(wc -l < ../.claude/tool-use.log)"
    echo "   Recent operations (last 10):"
    tail -10 ../.claude/tool-use.log | jq -r '.timestamp + " - " + .tool + " (" + (.size|tostring) + " chars)"' 2>/dev/null || tail -10 ../.claude/tool-use.log
else
    echo "   âš ï¸ Tool usage log not found"
fi

echo ""
echo "ğŸ“ˆ Step 3: Performance Metrics"
echo "   Backend response times (if available):"
if curl -s -m 2 http://localhost:8000/health &>/dev/null; then
    echo "   âœ… Backend is running - response time analysis available"
    curl -s -w "   Response time: %{time_total}s\n" -o /dev/null http://localhost:8000/health
else
    echo "   âš ï¸ Backend not running - no response time data"
fi

echo ""
echo "ğŸ’¡ Step 4: Optimization Recommendations"
echo "   Based on usage patterns:"
echo "   â€¢ Use '/clear' after completing major features to reduce context costs"
echo "   â€¢ Batch similar operations to reduce API calls"
echo "   â€¢ Use specific commands instead of general prompts"
echo "   â€¢ Monitor large file operations (>10KB) for cost impact"

echo ""
echo "âœ… Usage monitoring complete!"
echo "   ğŸ’¡ Run this command regularly to track costs and optimize usage"